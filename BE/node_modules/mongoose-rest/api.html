<html>
	<head>
		<title>mongoose-rest</title>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
		<style>body {
    margin: 0;
    padding: 0;
    font: 14px/1.5 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    color: #252519;
}
a {
    color: #252519;
}
a:hover {
    text-decoration: underline;
    color: #19469D;
}
p {
    margin: 12px 0;
}
h1, h2, h3 {
    margin: 0;
    padding: 0;
}
table#source {
    width: 100%;
    border-collapse: collapse;
}
table#source td:first-child {
    padding: 30px 40px 30px 40px;
    vertical-align: top;
}
table#source td:first-child,
table#source td:first-child pre {
    width: 450px;
}
table#source td:last-child {
    padding: 30px 0 30px 40px;
    border-left: 1px solid #E5E5EE;
    background: #F5F5FF;
}
table#source tr {
    border-bottom: 1px solid #E5E5EE;
}
table#source tr.filename {
    padding-top: 40px;
    border-top: 1px solid #E5E5EE;
}
table#source tr.filename td:first-child {
    text-transform: capitalize;
}
table#source tr.filename td:last-child {
    font-size: 12px;
}
table#source tr.filename h2 {
    margin: 0;
    padding: 0;
    cursor: pointer;
}
table#source tr.code h1,
table#source tr.code h2,
table#source tr.code h3 {
    margin-top: 30px;
    font-family: "Lucida Grande", "Helvetica Nueue", Arial, sans-serif;
    font-size: 18px;
}
table#source tr.code h2 {
    font-size: 16px;
}
table#source tr.code h3 {
    font-size: 14px;
}
table#source tr.code ul {
    margin: 15px 0 15px 35px;
    padding: 0;
}
table#source tr.code ul li {
    margin: 0;
    padding: 1px 0;
}
table#source tr.code ul li p {
    margin: 0;
    padding: 0;
}
table#source tr.code td:first-child pre {
    padding: 20px;
}
#ribbon {
    position: fixed;
    top: 0;
    right: 0;
}
code .string { color: #219161; }
code .regexp { color: #219161; }
code .keyword { color: #954121; }
code .number { color: #19469D; }
code .comment { color: #bbb; }
code .this { color: #19469D; }</style>
		<script>
			$(function(){
				$('tr.code').hide();
				$('tr.filename').toggle(function(){
					$(this).nextUntil('.filename').fadeIn();
				}, function(){
					$(this).nextUntil('.filename').fadeOut();
				});
			});
		</script>
	</head>
	<body>
<table id="source"><tbody><tr><td><h1>mongoose-rest</h1></td><td></td></tr><tr class="filename"><td><h2 id="lib/rest.js"><a href="#">rest</a></h2></td><td>lib/rest.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">models</span> = <span class="variable">require</span>(<span class="string">'./models'</span>)
  , <span class="variable">lingo</span> = <span class="variable">require</span>(<span class="string">'lingo'</span>).<span class="variable">en</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>The MongoDB ID format.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">id_format</span> = <span class="regexp">/^[0-9a-f]{24}$/</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Add RESTful routes.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>HTTPServer</em>  app</p></li><li><p><strong>param</strong>: <em>object</em>  routes</p></li><li><p><strong>param</strong>: <em>string</em>  prefix</p></li><li><p><strong>param</strong>: <em>string</em>  singular</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">addRoutes</span> (<span class="variable">app</span>, <span class="variable">routes</span>, <span class="variable">prefix</span>, <span class="variable">singular</span>) {
    <span class="variable">app</span>.<span class="variable">get</span>    ( <span class="variable">prefix</span> + <span class="string">'.:format?'</span>                   , <span class="variable">routes</span>.<span class="variable">index</span>  );
    <span class="variable">app</span>.<span class="variable">post</span>   ( <span class="variable">prefix</span>                                 , <span class="variable">routes</span>.<span class="variable">create</span> );
    <span class="variable">app</span>.<span class="variable">get</span>    ( <span class="variable">prefix</span> + <span class="string">'/:'</span> + <span class="variable">singular</span> + <span class="string">'.:format?'</span> , <span class="variable">routes</span>.<span class="variable">read</span>   );
    <span class="variable">app</span>.<span class="variable">put</span>    ( <span class="variable">prefix</span> + <span class="string">'/:'</span> + <span class="variable">singular</span>               , <span class="variable">routes</span>.<span class="variable">update</span> );
    <span class="variable">app</span>.<span class="keyword">delete</span> ( <span class="variable">prefix</span> + <span class="string">'/:'</span> + <span class="variable">singular</span>               , <span class="variable">routes</span>.<span class="variable">destroy</span>);
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Create resource-based, RESTful routes for mongoose models.
All models must be defined before calling this method.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>HTTPServer</em>  app</p></li><li><p><strong>param</strong>: <em>object</em>  config (optional)</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">create</span> = <span class="keyword">function</span> (<span class="variable">app</span>, <span class="variable">config</span>) {
    <span class="variable">config</span> = <span class="variable">config</span> || {};

    <span class="comment">//Set config defaults</span>
    <span class="variable">config</span>.<span class="variable">default_limit</span> = <span class="variable">config</span>.<span class="variable">default_limit</span> || <span class="number integer">20</span>
    <span class="variable">config</span>.<span class="variable">max_limit</span> = <span class="variable">config</span>.<span class="variable">max_limit</span> || <span class="number integer">100</span>;

    <span class="comment">//Add routes for each top level model</span>
    <span class="variable">models</span>.<span class="variable">getTopLevel</span>().<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">resource</span>) {

        <span class="keyword">var</span> <span class="variable">singular</span> = <span class="variable">lingo</span>.<span class="variable">singularize</span>(<span class="variable">resource</span>)
          , <span class="variable">plural</span> = <span class="variable">lingo</span>.<span class="variable">pluralize</span>(<span class="variable">resource</span>)
          , <span class="variable">top_prefix</span> = (<span class="variable">config</span>.<span class="variable">path</span> || <span class="string">'/'</span>) + <span class="variable">plural</span>
          , <span class="variable">routes</span>;

        <span class="comment">//Autoload a resource when the param is part of a route</span>
        <span class="variable">autoloadTopLevelResource</span>(<span class="variable">app</span>, <span class="variable">resource</span>, <span class="variable">config</span>);

        <span class="comment">//Add RESTful routes</span>
        <span class="variable">routes</span> = <span class="variable">topLevelRoutes</span>(<span class="variable">app</span>, <span class="variable">top_prefix</span>, <span class="variable">resource</span>, <span class="variable">config</span>);

        <span class="variable">addRoutes</span>(<span class="variable">app</span>, <span class="variable">routes</span>, <span class="variable">top_prefix</span>, <span class="variable">singular</span>);

        <span class="comment">//Add routes for embedded documents</span>
        <span class="variable">models</span>.<span class="variable">getChildren</span>(<span class="variable">resource</span>).<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">embedded</span>) {

            <span class="keyword">var</span> <span class="variable">prefix</span> = <span class="variable">top_prefix</span> + <span class="string">'/:'</span> + <span class="variable">singular</span>;

            <span class="variable">autoloadEmbeddedResource</span>(<span class="variable">app</span>, <span class="variable">resource</span>,
                <span class="variable">embedded</span>.<span class="variable">resource</span>, <span class="variable">embedded</span>.<span class="variable">attribute</span>, <span class="variable">config</span>);

            <span class="variable">routes</span> = <span class="variable">embeddedRoutes</span>(<span class="variable">app</span>, <span class="variable">prefix</span>, <span class="variable">resource</span>, <span class="variable">embedded</span>.<span class="variable">resource</span>,
                                        <span class="variable">embedded</span>.<span class="variable">attribute</span>);

            <span class="variable">addRoutes</span>(<span class="variable">app</span>, <span class="variable">routes</span>, <span class="variable">prefix</span> + <span class="string">'/'</span> + <span class="variable">embedded</span>.<span class="variable">plural</span>, <span class="variable">embedded</span>.<span class="variable">singular</span>);

        });

    });

    <span class="variable">app</span>.<span class="variable">dynamicHelpers</span>({<span class="variable">resource</span>: <span class="keyword">function</span> (<span class="variable">request</span>, <span class="variable">response</span>) {
        <span class="keyword">return</span> <span class="variable">request</span>.<span class="variable">resource</span>;
    }});
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Autoload a resource when a route contains it as a parameter, e.g.
/posts/:post will automatically load the requested post, where :post
is either an ID or unique slug, e.g. /posts/my-test-post or /posts/23</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>HTTPServer</em>  app</p></li><li><p><strong>param</strong>: <em>string</em>  resource</p></li><li><p><strong>param</strong>: <em>object</em>  config (optional)</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">autoloadTopLevelResource</span> (<span class="variable">app</span>, <span class="variable">resource</span>, <span class="variable">config</span>) {
    <span class="keyword">var</span> <span class="variable">model</span> = <span class="variable">models</span>.<span class="variable">mongoose</span>.<span class="variable">model</span>(<span class="variable">resource</span>)
      , <span class="variable">singular</span> = <span class="variable">lingo</span>.<span class="variable">singularize</span>(<span class="variable">resource</span>);

    <span class="variable">app</span>.<span class="variable">param</span>(<span class="variable">singular</span>, <span class="keyword">function</span> (<span class="variable">request</span>, <span class="variable">response</span>, <span class="variable">next</span>) {
        <span class="keyword">var</span> <span class="variable">id</span> = <span class="variable">request</span>.<span class="variable">params</span>[<span class="variable">singular</span>];

        <span class="keyword">function</span> <span class="variable">handleResource</span> (<span class="variable">err</span>, <span class="variable">obj</span>) {
            <span class="keyword">if</span> (<span class="variable">err</span>) {
                <span class="keyword">return</span> <span class="variable">next</span>(<span class="keyword">new</span> <span class="class">Error</span>(<span class="variable">err</span>));
            } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">null</span> == <span class="variable">obj</span>) {
                <span class="keyword">if</span> (<span class="variable">request</span>.<span class="variable">xhr</span> || <span class="variable">request</span>.<span class="variable">format</span>) {
                    <span class="variable">response</span>.<span class="variable">send</span>(<span class="number integer">404</span>);
                } <span class="keyword">else</span> {
                    <span class="variable">request</span>.<span class="variable">flash</span>(<span class="string">'error'</span>, <span class="string">'The %s could not be found.'</span>, <span class="variable">singular</span>);
                    <span class="variable">response</span>.<span class="variable">redirect</span>(<span class="string">'back'</span>);
                }
            } <span class="keyword">else</span> {
                <span class="variable">request</span>.<span class="variable">resource</span>(<span class="variable">singular</span>, <span class="variable">obj</span>);
                <span class="variable">next</span>();
            }
        }

        <span class="comment">//Is there a unique slug attribute we can lookup by? If not, lookup by ID</span>
        <span class="keyword">if</span> (<span class="variable">model</span>.<span class="variable">schema</span>.<span class="variable">tree</span>.<span class="variable">slug</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; !<span class="variable">id_format</span>.<span class="variable">test</span>(<span class="variable">id</span>)) {
            <span class="variable">model</span>.<span class="variable">findOne</span>({<span class="variable">slug</span>: <span class="variable">id</span>}, <span class="variable">handleResource</span>);
        } <span class="keyword">else</span> {
            <span class="variable">model</span>.<span class="variable">findById</span>(<span class="variable">id</span>, <span class="variable">handleResource</span>);
        }
    });
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Autoload an embedded resource when a route contains it as a parameter, e.g.
/posts/:post/commments/:comment will automatically load the requested
comment (assuming the post has already been loaded).</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>HTTPServer</em>  app</p></li><li><p><strong>param</strong>: <em>string</em>  parent</p></li><li><p><strong>param</strong>: <em>string</em>  resource</p></li><li><p><strong>param</strong>: <em>string</em>  attribute - the attribute name of the embedded resource</p></li><li><p><strong>param</strong>: <em>object</em>  config (optional)</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">autoloadEmbeddedResource</span> (<span class="variable">app</span>, <span class="variable">parent</span>, <span class="variable">resource</span>, <span class="variable">attribute</span>, <span class="variable">config</span>) {
    <span class="keyword">var</span> <span class="variable">model</span> = <span class="variable">models</span>.<span class="variable">mongoose</span>.<span class="variable">model</span>(<span class="variable">resource</span>)
      , <span class="variable">singular</span> = <span class="variable">lingo</span>.<span class="variable">singularize</span>(<span class="variable">resource</span>)
      , <span class="variable">parent_singular</span> = <span class="variable">lingo</span>.<span class="variable">singularize</span>(<span class="variable">parent</span>);

    <span class="variable">app</span>.<span class="variable">param</span>(<span class="variable">singular</span>, <span class="keyword">function</span> (<span class="variable">request</span>, <span class="variable">response</span>, <span class="variable">next</span>) {
        <span class="keyword">var</span> <span class="variable">parent</span> = <span class="variable">request</span>.<span class="variable">resource</span>(<span class="variable">parent_singular</span>)
          , <span class="variable">id</span> = <span class="variable">request</span>.<span class="variable">params</span>[<span class="variable">singular</span>];
        <span class="keyword">if</span> (<span class="variable">parent</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">attribute</span> <span class="keyword">in</span> <span class="variable">parent</span>) {
            <span class="variable">parent</span>[<span class="variable">attribute</span>].<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">child</span>) {
                <span class="keyword">if</span> (<span class="variable">child</span>.<span class="variable">get</span>(<span class="string">'id'</span>) == <span class="variable">id</span>) {
                    <span class="variable">request</span>.<span class="variable">resource</span>(<span class="variable">singular</span>, <span class="variable">child</span>);
                    <span class="keyword">return</span> <span class="variable">next</span>();
                }
            });
        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">request</span>.<span class="variable">xhr</span> || <span class="variable">request</span>.<span class="variable">format</span>) {
            <span class="variable">response</span>.<span class="variable">send</span>([]);
        } <span class="keyword">else</span> {
            <span class="variable">request</span>.<span class="variable">flash</span>(<span class="string">'error'</span>, <span class="string">'The %s could not be found.'</span>, <span class="variable">singular</span>);
            <span class="variable">response</span>.<span class="variable">redirect</span>(<span class="string">'back'</span>);
        }
    });
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Generate routes for top level models.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>HTTPServer</em>  app</p></li><li><p><strong>param</strong>: <em>string</em>  resource</p></li><li><p><strong>param</strong>: <em>object</em>  config (optional)</p></li><li><p><strong>return</strong>: <em>object</em>  routes</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">topLevelRoutes</span> (<span class="variable">app</span>, <span class="variable">prefix</span>, <span class="variable">resource</span>, <span class="variable">config</span>) {

    <span class="keyword">var</span> <span class="variable">model</span> = <span class="variable">models</span>.<span class="variable">mongoose</span>.<span class="variable">model</span>(<span class="variable">resource</span>)
      , <span class="variable">singular</span> = <span class="variable">lingo</span>.<span class="variable">singularize</span>(<span class="variable">resource</span>)
      , <span class="variable">plural</span> = <span class="variable">lingo</span>.<span class="variable">pluralize</span>(<span class="variable">resource</span>)
      , <span class="variable">routes</span> = {};

    <span class="comment">//GET /&lt;resource&gt;</span>
    <span class="variable">routes</span>.<span class="variable">index</span> = <span class="keyword">function</span> (<span class="variable">request</span>, <span class="variable">response</span>, <span class="variable">next</span>) {
        <span class="keyword">var</span> <span class="variable">page</span> = <span class="variable">request</span>.<span class="variable">query</span>.<span class="variable">page</span> || <span class="number integer">1</span>
          , <span class="variable">limit</span> = <span class="class">Math</span>.<span class="variable">min</span>(<span class="variable">config</span>.<span class="variable">max_limit</span>, <span class="variable">request</span>.<span class="variable">query</span>.<span class="variable">limit</span>
                                                   || <span class="variable">config</span>.<span class="variable">default_limit</span>)
          , <span class="variable">offset</span> = (<span class="variable">page</span> - <span class="number integer">1</span>) * <span class="variable">limit</span>
          , <span class="variable">locals</span> = {}
          , <span class="variable">query</span>;

        <span class="keyword">function</span> <span class="variable">doQuery</span>(<span class="variable">query</span>) {
            <span class="variable">query</span>.<span class="variable">skip</span>(<span class="variable">offset</span>).<span class="variable">limit</span>(<span class="variable">limit</span>).<span class="variable">run</span>(<span class="keyword">function</span> (<span class="variable">err</span>, <span class="variable">results</span>) {
                <span class="keyword">if</span> (<span class="variable">err</span>) {
                    <span class="keyword">return</span> <span class="variable">next</span>(<span class="keyword">new</span> <span class="class">Error</span>(<span class="variable">err</span>));
                } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">request</span>.<span class="variable">xhr</span> || <span class="variable">request</span>.<span class="variable">format</span> === <span class="string">'json'</span>) {
                    <span class="keyword">return</span> <span class="variable">response</span>.<span class="variable">send</span>(<span class="variable">results</span> || []);
                }
                <span class="keyword">var</span> <span class="variable">locals</span> = {
                    <span class="variable">limit</span>  : <span class="variable">limit</span>
                  , <span class="variable">page</span>   : <span class="variable">page</span>
                  , <span class="variable">offset</span> : <span class="variable">offset</span>
                  , <span class="variable">query</span>  : <span class="variable">request</span>.<span class="variable">query</span>
                }
                <span class="variable">locals</span>[<span class="variable">plural</span>] = <span class="variable">results</span> || [];
                <span class="variable">response</span>.<span class="variable">locals</span>(<span class="variable">locals</span>);
                <span class="variable">request</span>.<span class="variable">resource</span>(<span class="variable">plural</span>, <span class="variable">results</span>);
                <span class="variable">response</span>.<span class="variable">render</span>(<span class="variable">plural</span> + <span class="string">'/index'</span>);
            });
        }

        <span class="comment">//Use Model.search() if it's defined</span>
        <span class="keyword">if</span> (<span class="variable">model</span>.<span class="variable">search</span>) {
            <span class="variable">model</span>.<span class="variable">search</span>(<span class="variable">request</span>.<span class="variable">query</span>, <span class="variable">request</span>.<span class="variable">user</span>, <span class="keyword">function</span> (<span class="variable">err</span>, <span class="variable">query</span>) {
                <span class="keyword">if</span> (<span class="variable">err</span>) {
                    <span class="keyword">return</span> <span class="variable">next</span>(<span class="keyword">new</span> <span class="class">Error</span>(<span class="variable">err</span>));
                }
                <span class="variable">doQuery</span>(<span class="variable">query</span>);
            });
        } <span class="keyword">else</span> {
            <span class="variable">query</span> = <span class="variable">model</span>.<span class="variable">find</span>();
            <span class="keyword">if</span> (<span class="variable">request</span>.<span class="variable">query</span>.<span class="variable">order</span>) {
                <span class="variable">query</span> = <span class="variable">query</span>.<span class="variable">sort</span>([[
                    <span class="variable">request</span>.<span class="variable">query</span>.<span class="variable">order</span>, <span class="variable">request</span>.<span class="variable">query</span>.<span class="variable">desc</span> ? <span class="string">'descending'</span>
                                                            : <span class="string">'ascending'</span>
                ]]);
            }
            <span class="variable">doQuery</span>(<span class="variable">query</span>);
        }
    }

    <span class="comment">//POST /&lt;resource&gt;</span>
    <span class="variable">routes</span>.<span class="variable">create</span> = <span class="keyword">function</span> (<span class="variable">request</span>, <span class="variable">response</span>, <span class="variable">next</span>) {
        <span class="keyword">var</span> <span class="variable">attr</span>, <span class="variable">instance</span> = <span class="keyword">new</span> <span class="variable">model</span>();
        <span class="keyword">for</span> (<span class="variable">attr</span> <span class="keyword">in</span> <span class="variable">request</span>.<span class="variable">body</span>) {
            <span class="keyword">if</span> (!(<span class="variable">attr</span> <span class="keyword">in</span> <span class="variable">model</span>.<span class="variable">schema</span>.<span class="variable">tree</span>)) {
                <span class="keyword">delete</span> <span class="variable">request</span>.<span class="variable">body</span>[<span class="variable">attr</span>];
            }
        }
        <span class="keyword">if</span> (<span class="variable">model</span>.<span class="variable">filter</span>) {
            <span class="variable">request</span>.<span class="variable">body</span> = <span class="variable">model</span>.<span class="variable">filter</span>(<span class="variable">request</span>.<span class="variable">body</span>);
        }
        <span class="keyword">for</span> (<span class="variable">attr</span> <span class="keyword">in</span> <span class="variable">request</span>.<span class="variable">body</span>) {
            <span class="variable">instance</span>[<span class="variable">attr</span>] = <span class="variable">request</span>.<span class="variable">body</span>[<span class="variable">attr</span>];
        }
        <span class="variable">instance</span>.<span class="variable">save</span>(<span class="keyword">function</span> (<span class="variable">err</span>) {
            <span class="keyword">if</span> (<span class="variable">err</span>) {
                    <span class="keyword">return</span> <span class="variable">next</span>(<span class="keyword">new</span> <span class="class">Error</span>(<span class="variable">err</span>));
            } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">request</span>.<span class="variable">xhr</span> || <span class="variable">request</span>.<span class="variable">format</span> === <span class="string">'json'</span>) {
                <span class="keyword">return</span> <span class="variable">response</span>.<span class="variable">send</span>(<span class="variable">instance</span>);
            }
            <span class="variable">request</span>.<span class="variable">flash</span>(<span class="string">'info'</span>, <span class="string">'The %s was created successfully'</span>, <span class="variable">singular</span>);
            <span class="variable">response</span>.<span class="variable">redirect</span>(<span class="string">'/'</span> + <span class="variable">plural</span>);
        });
    }

    <span class="comment">//GET /&lt;resource&gt;/:id</span>
    <span class="variable">routes</span>.<span class="variable">read</span> = <span class="keyword">function</span> (<span class="variable">request</span>, <span class="variable">response</span>, <span class="variable">next</span>) {
        <span class="keyword">if</span> (<span class="variable">request</span>.<span class="variable">xhr</span> || <span class="variable">request</span>.<span class="variable">format</span> === <span class="string">'json'</span>) {
            <span class="keyword">return</span> <span class="variable">response</span>.<span class="variable">send</span>(<span class="variable">request</span>.<span class="variable">resource</span>(<span class="variable">singular</span>).<span class="variable">toJSON</span>());
        }
        <span class="variable">response</span>.<span class="variable">local</span>(<span class="string">'instance'</span>, <span class="variable">request</span>.<span class="variable">resource</span>(<span class="variable">singular</span>));
        <span class="variable">response</span>.<span class="variable">render</span>(<span class="variable">plural</span> + <span class="string">'/read'</span>);
    }

    <span class="comment">//PUT /&lt;resource&gt;/:id</span>
    <span class="variable">routes</span>.<span class="variable">update</span> = <span class="keyword">function</span> (<span class="variable">request</span>, <span class="variable">response</span>, <span class="variable">next</span>) {
        <span class="keyword">var</span> <span class="variable">attr</span>, <span class="variable">instance</span> = <span class="variable">request</span>.<span class="variable">resource</span>(<span class="variable">singular</span>);
        <span class="keyword">for</span> (<span class="variable">attr</span> <span class="keyword">in</span> <span class="variable">request</span>.<span class="variable">body</span>) {
            <span class="keyword">if</span> (!(<span class="variable">attr</span> <span class="keyword">in</span> <span class="variable">model</span>.<span class="variable">schema</span>.<span class="variable">tree</span>)) {
                <span class="keyword">delete</span> <span class="variable">request</span>.<span class="variable">body</span>[<span class="variable">attr</span>];
            }
        }
        <span class="keyword">if</span> (<span class="variable">model</span>.<span class="variable">filter</span>) {
            <span class="variable">request</span>.<span class="variable">body</span> = <span class="variable">model</span>.<span class="variable">filter</span>(<span class="variable">request</span>.<span class="variable">body</span>);
        }
        <span class="keyword">for</span> (<span class="variable">attr</span> <span class="keyword">in</span> <span class="variable">request</span>.<span class="variable">body</span>) {
            <span class="variable">instance</span>[<span class="variable">attr</span>] = <span class="variable">request</span>.<span class="variable">body</span>[<span class="variable">attr</span>];
        }
        <span class="variable">instance</span>.<span class="variable">save</span>(<span class="keyword">function</span> (<span class="variable">err</span>) {
            <span class="keyword">if</span> (<span class="variable">err</span>) {
                <span class="keyword">return</span> <span class="variable">next</span>(<span class="keyword">new</span> <span class="class">Error</span>(<span class="variable">err</span>));
            } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">request</span>.<span class="variable">xhr</span> || <span class="variable">request</span>.<span class="variable">format</span> === <span class="string">'json'</span>) {
                <span class="keyword">return</span> <span class="variable">response</span>.<span class="variable">send</span>(<span class="variable">instance</span>);
            }
            <span class="variable">request</span>.<span class="variable">flash</span>(<span class="string">'info'</span>, <span class="string">'The %s was updated successfully'</span>, <span class="variable">singular</span>);
            <span class="variable">response</span>.<span class="variable">redirect</span>(<span class="string">'/'</span> + <span class="variable">plural</span> + <span class="string">'/'</span> + <span class="variable">request</span>.<span class="variable">params</span>.<span class="variable">id</span>);
        });
    }

    <span class="comment">//DELETE /&lt;resource&gt;/:id</span>
    <span class="variable">routes</span>.<span class="variable">destroy</span> = <span class="keyword">function</span> (<span class="variable">request</span>, <span class="variable">response</span>, <span class="variable">next</span>) {
        <span class="variable">request</span>.<span class="variable">resource</span>(<span class="variable">singular</span>).<span class="variable">remove</span>(<span class="keyword">function</span> (<span class="variable">err</span>) {
            <span class="keyword">if</span> (<span class="variable">err</span>) {
                <span class="keyword">return</span> <span class="variable">next</span>(<span class="keyword">new</span> <span class="class">Error</span>(<span class="variable">err</span>));
            } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">request</span>.<span class="variable">xhr</span> || <span class="variable">request</span>.<span class="variable">format</span> === <span class="string">'json'</span>) {
                <span class="keyword">return</span> <span class="variable">response</span>.<span class="variable">send</span>(<span class="number integer">200</span>);
            }
            <span class="variable">request</span>.<span class="variable">flash</span>(<span class="string">'info'</span>, <span class="string">'The %s was removed successfully'</span>, <span class="variable">singular</span>);
            <span class="variable">response</span>.<span class="variable">redirect</span>(<span class="string">'/'</span> + <span class="variable">plural</span>);
        });
    }

    <span class="comment">//If there's a static acl() method, patch each action to route through it</span>
    <span class="keyword">if</span> (<span class="variable">model</span>.<span class="variable">acl</span>) {
        <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">action</span> <span class="keyword">in</span> <span class="variable">routes</span>) {
            (<span class="keyword">function</span> (<span class="variable">action</span>, <span class="variable">handle</span>) {
                <span class="variable">routes</span>[<span class="variable">action</span>] = <span class="keyword">function</span> (<span class="variable">request</span>, <span class="variable">response</span>, <span class="variable">next</span>) {
                    <span class="keyword">var</span> <span class="variable">user</span> = <span class="variable">request</span>.<span class="variable">user</span> || <span class="keyword">null</span>
                      , <span class="variable">obj</span> = <span class="variable">request</span>.<span class="variable">resource</span>(<span class="variable">singular</span>) || <span class="variable">request</span>.<span class="variable">body</span>;
                    <span class="variable">model</span>.<span class="variable">acl</span>(<span class="variable">user</span>, <span class="variable">action</span>, <span class="variable">obj</span>, <span class="keyword">function</span> (<span class="variable">ok</span>) {
                        <span class="keyword">if</span> (!<span class="variable">ok</span>) <span class="variable">next</span>(<span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'auth'</span>));
                        <span class="keyword">else</span> <span class="variable">handle</span>(<span class="variable">request</span>, <span class="variable">response</span>, <span class="variable">next</span>);
                    });
                }
            })(<span class="variable">action</span>, <span class="variable">routes</span>[<span class="variable">action</span>]);
        }
    }

    <span class="keyword">return</span> <span class="variable">routes</span>;
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Generate routes for embedded documents.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>HTTPServer</em>  app</p></li><li><p><strong>param</strong>: <em>string</em>  prefix</p></li><li><p><strong>param</strong>: <em>string</em>  parent</p></li><li><p><strong>param</strong>: <em>string</em>  resource</p></li><li><p><strong>param</strong>: <em>string</em>  attribute</p></li><li><p><strong>param</strong>: <em>object</em>  config (optional)</p></li><li><p><strong>return</strong>: <em>object</em>  routes</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">embeddedRoutes</span> (<span class="variable">app</span>, <span class="variable">prefix</span>, <span class="variable">parent_resource</span>, <span class="variable">resource</span>, <span class="variable">attribute</span>) {

    <span class="keyword">var</span> <span class="variable">model</span> = <span class="variable">models</span>.<span class="variable">mongoose</span>.<span class="variable">model</span>(<span class="variable">resource</span>)
      , <span class="variable">plural</span> = <span class="variable">lingo</span>.<span class="variable">pluralize</span>(<span class="variable">resource</span>)
      , <span class="variable">singular</span> = <span class="variable">lingo</span>.<span class="variable">singularize</span>(<span class="variable">resource</span>)
      , <span class="variable">parent_model</span> = <span class="variable">models</span>.<span class="variable">mongoose</span>.<span class="variable">model</span>(<span class="variable">parent_resource</span>)
      , <span class="variable">parent_plural</span> = <span class="variable">lingo</span>.<span class="variable">pluralize</span>(<span class="variable">parent_resource</span>)
      , <span class="variable">parent_singular</span> = <span class="variable">lingo</span>.<span class="variable">singularize</span>(<span class="variable">parent_resource</span>)
      , <span class="variable">routes</span> = {};

    <span class="variable">prefix</span> += <span class="string">'/'</span> + <span class="variable">plural</span>;

    <span class="comment">//GET /&lt;parent_resource&gt;/:parent_id/&lt;resource&gt;</span>
    <span class="variable">routes</span>.<span class="variable">index</span> = <span class="keyword">function</span> (<span class="variable">request</span>, <span class="variable">response</span>, <span class="variable">next</span>) {
        <span class="keyword">var</span> <span class="variable">parent</span> = <span class="variable">request</span>.<span class="variable">resource</span>(<span class="variable">parent_singular</span>)
          , <span class="variable">children</span> = [];

        <span class="keyword">if</span> (<span class="variable">parent</span>[<span class="variable">attribute</span>] &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">parent</span>[<span class="variable">attribute</span>].<span class="variable">length</span>) {
            <span class="variable">parent</span>[<span class="variable">attribute</span>].<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">child</span>) {
                <span class="comment">//Convert each child to a JSON string</span>
                <span class="keyword">var</span> <span class="variable">obj</span> = <span class="variable">child</span>.<span class="variable">toJSON</span>();
                <span class="variable">obj</span>.<span class="variable">id</span> = <span class="variable">obj</span>.<span class="variable">_id</span>;
                <span class="keyword">delete</span> <span class="variable">obj</span>.<span class="variable">_id</span>;
                <span class="variable">children</span>.<span class="variable">push</span>(<span class="variable">obj</span>);
            });
        }
        <span class="keyword">return</span> <span class="variable">response</span>.<span class="variable">send</span>(<span class="variable">children</span>);
    }

    <span class="comment">//POST /&lt;parent_resource&gt;/:parent_id/&lt;resource&gt;/:id</span>
    <span class="variable">routes</span>.<span class="variable">create</span> = <span class="keyword">function</span> (<span class="variable">request</span>, <span class="variable">response</span>, <span class="variable">next</span>) {
        <span class="keyword">var</span> <span class="variable">parent</span> = <span class="variable">request</span>.<span class="variable">resource</span>(<span class="variable">parent_singular</span>)
          , <span class="variable">child</span> = <span class="keyword">new</span> <span class="variable">model</span>();
        <span class="keyword">if</span> (!<span class="variable">parent</span>[<span class="variable">attribute</span>]) {
            <span class="variable">parent</span>[<span class="variable">attribute</span>] = [];
        }
        <span class="keyword">for</span> (<span class="variable">attr</span> <span class="keyword">in</span> <span class="variable">request</span>.<span class="variable">body</span>) {
            <span class="keyword">if</span> (<span class="variable">attr</span> <span class="keyword">in</span> <span class="variable">model</span>.<span class="variable">schema</span>.<span class="variable">tree</span>) {
                <span class="variable">child</span>[<span class="variable">attr</span>] = <span class="variable">request</span>.<span class="variable">body</span>[<span class="variable">attr</span>];
            }
        }
        <span class="variable">parent</span>[<span class="variable">attribute</span>].<span class="variable">push</span>(<span class="variable">child</span>);
        <span class="variable">parent</span>.<span class="variable">save</span>(<span class="keyword">function</span> (<span class="variable">err</span>) {
            <span class="keyword">if</span> (<span class="variable">err</span>) {
                <span class="keyword">return</span> <span class="variable">next</span>(<span class="keyword">new</span> <span class="class">Error</span>(<span class="variable">err</span>));
            }
            <span class="variable">response</span>.<span class="variable">send</span>(<span class="variable">child</span>.<span class="variable">toJSON</span>());
        });
    }

    <span class="comment">//GET /&lt;parent_resource&gt;/:parent_id/&lt;resource&gt;/:id</span>
    <span class="variable">routes</span>.<span class="variable">read</span> = <span class="keyword">function</span> (<span class="variable">request</span>, <span class="variable">response</span>, <span class="variable">next</span>) {
        <span class="keyword">var</span> <span class="variable">instance</span> = <span class="variable">request</span>.<span class="variable">resource</span>(<span class="variable">singular</span>);
        <span class="variable">response</span>.<span class="variable">send</span>(<span class="variable">instance</span>);
    }

    <span class="comment">//PUT /&lt;parent_resource&gt;/:parent_id/&lt;resource&gt;/:id</span>
    <span class="variable">routes</span>.<span class="variable">update</span> = <span class="keyword">function</span> (<span class="variable">request</span>, <span class="variable">response</span>, <span class="variable">next</span>) {
        <span class="keyword">var</span> <span class="variable">instance</span> = <span class="variable">request</span>.<span class="variable">resource</span>(<span class="variable">singular</span>)
          , <span class="variable">parent</span> = <span class="variable">request</span>.<span class="variable">resource</span>(<span class="variable">parent_singular</span>);
        <span class="keyword">for</span> (<span class="variable">attr</span> <span class="keyword">in</span> <span class="variable">request</span>.<span class="variable">body</span>) {
            <span class="keyword">if</span> (<span class="variable">attr</span> <span class="keyword">in</span> <span class="variable">model</span>.<span class="variable">schema</span>.<span class="variable">tree</span>) {
                <span class="variable">instance</span>[<span class="variable">attr</span>] = <span class="variable">request</span>.<span class="variable">body</span>[<span class="variable">attr</span>];
            }
        }
        <span class="variable">parent</span>.<span class="variable">save</span>(<span class="keyword">function</span> (<span class="variable">err</span>) {
            <span class="keyword">if</span> (<span class="variable">err</span>) {
                <span class="keyword">return</span> <span class="variable">next</span>(<span class="keyword">new</span> <span class="class">Error</span>(<span class="variable">err</span>));
            }
            <span class="variable">response</span>.<span class="variable">send</span>(<span class="number integer">200</span>);
        });
    }

    <span class="comment">//DELETE /&lt;parent_resource&gt;/:parent_id/&lt;resource&gt;/:id</span>
    <span class="variable">routes</span>.<span class="variable">destroy</span> = <span class="keyword">function</span> (<span class="variable">request</span>, <span class="variable">response</span>, <span class="variable">next</span>) {
        <span class="keyword">var</span> <span class="variable">instance</span> = <span class="variable">request</span>.<span class="variable">resource</span>(<span class="variable">singular</span>)
          , <span class="variable">parent</span> = <span class="variable">request</span>.<span class="variable">resource</span>(<span class="variable">parent_singular</span>);
        <span class="variable">instance</span>.<span class="variable">remove</span>();
        <span class="variable">parent</span>.<span class="variable">save</span>(<span class="keyword">function</span> (<span class="variable">err</span>) {
            <span class="keyword">if</span> (<span class="variable">err</span>) {
                <span class="keyword">return</span> <span class="variable">next</span>(<span class="keyword">new</span> <span class="class">Error</span>(<span class="variable">err</span>));
            }
            <span class="variable">response</span>.<span class="variable">send</span>(<span class="number integer">200</span>);
        });
    }

    <span class="comment">//Run each embedded document route through the parent's acl() method</span>
    <span class="keyword">if</span> (<span class="variable">parent_model</span>.<span class="variable">acl</span>) {
        <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">action</span> <span class="keyword">in</span> <span class="variable">routes</span>) {
            (<span class="keyword">function</span> (<span class="variable">action</span>, <span class="variable">handle</span>) {
                <span class="variable">routes</span>[<span class="variable">action</span>] = <span class="keyword">function</span> (<span class="variable">request</span>, <span class="variable">response</span>, <span class="variable">next</span>) {
                    <span class="keyword">var</span> <span class="variable">user</span> = <span class="variable">request</span>.<span class="variable">user</span> || <span class="keyword">null</span>
                      , <span class="variable">obj</span> = <span class="variable">request</span>.<span class="variable">resource</span>(<span class="variable">singular</span>) || <span class="variable">request</span>.<span class="variable">body</span>;
                    <span class="variable">parent_model</span>.<span class="variable">acl</span>(<span class="variable">user</span>, <span class="variable">action</span>, <span class="variable">obj</span>, <span class="keyword">function</span> (<span class="variable">ok</span>) {
                        <span class="keyword">if</span> (!<span class="variable">ok</span>) <span class="variable">next</span>(<span class="keyword">new</span> <span class="class">Error</span>(<span class="string">'auth'</span>));
                        <span class="keyword">else</span> <span class="variable">handle</span>(<span class="variable">request</span>, <span class="variable">response</span>, <span class="variable">next</span>);
                    });
                }
            })(<span class="variable">action</span>, <span class="variable">routes</span>[<span class="variable">action</span>]);
        }
    }

    <span class="keyword">return</span> <span class="variable">routes</span>;
}

</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/request.js"><a href="#">request</a></h2></td><td>lib/request.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">http</span> = <span class="variable">require</span>(<span class="string">'http'</span>)
  , <span class="variable">request</span> = <span class="variable">http</span>.<span class="class">IncomingMessage</span>.<span class="variable">prototype</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Bind a resource to the request.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>string</em>  name</p></li><li><p><strong>param</strong>: <em>object</em>  resource</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">request</span>.<span class="variable">resource</span> = <span class="keyword">function</span> (<span class="variable">name</span>, <span class="variable">resource</span>) {
    <span class="keyword">if</span> (<span class="variable">arguments</span>.<span class="variable">length</span> == <span class="number integer">2</span>) {
        <span class="this">this</span>.<span class="variable">resources</span> = <span class="this">this</span>.<span class="variable">resource</span> || {};
        <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">resources</span>[<span class="variable">name</span>] = <span class="variable">resource</span>;
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="this">this</span>.<span class="variable">resources</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">name</span> <span class="keyword">in</span> <span class="this">this</span>.<span class="variable">resources</span>) {
        <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">resources</span>[<span class="variable">name</span>]
    }
    <span class="keyword">return</span> <span class="keyword">null</span>;
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Check if the request has the specified resource.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>string</em>  name</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">request</span>.<span class="variable">hasResource</span> = <span class="keyword">function</span> (<span class="variable">name</span>) {
    <span class="keyword">return</span> <span class="this">this</span>.<span class="variable">resources</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">name</span> <span class="keyword">in</span> <span class="this">this</span>.<span class="variable">resources</span>;
}

</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/models.js"><a href="#">models</a></h2></td><td>lib/models.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">lingo</span> = <span class="variable">require</span>(<span class="string">'lingo'</span>).<span class="variable">en</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>The schema map.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">embedded</span> = [], <span class="variable">top_level</span> = []
  , <span class="variable">child_map</span> = {}
  , <span class="variable">parent_map</span> = {};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>The mongoose instance in use.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">mongoose</span> = <span class="keyword">null</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>A hacky way of mapping attributes =&gt; names.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Schema</em>  schema</p></li><li><p><strong>return</strong>: <em>string</em>  key</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">attrKey</span>(<span class="variable">schema</span>) {
    <span class="keyword">return</span> <span class="class">Object</span>.<span class="variable">keys</span>(<span class="variable">schema</span>.<span class="variable">tree</span>).<span class="variable">join</span>(<span class="string">'-'</span>);
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Build a schema map.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Mongoose</em>  mongoose</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">use</span> = <span class="keyword">function</span> (<span class="variable">mongoose</span>) {

    <span class="variable">exports</span>.<span class="variable">mongoose</span> = <span class="variable">mongoose</span>;

    <span class="keyword">var</span> <span class="variable">key</span>, <span class="variable">model</span>, <span class="variable">attr</span>, <span class="variable">schema</span>, <span class="variable">attr_map</span> = {};

    <span class="comment">//Create a map of attributes =&gt; model name</span>
    <span class="keyword">for</span> (<span class="variable">model</span> <span class="keyword">in</span> <span class="variable">mongoose</span>.<span class="variable">modelSchemas</span>) {
        <span class="variable">schema</span> = <span class="variable">mongoose</span>.<span class="variable">modelSchemas</span>[<span class="variable">model</span>];
        <span class="variable">key</span> = <span class="variable">attrKey</span>(<span class="variable">schema</span>);
        <span class="keyword">if</span> (<span class="variable">key</span> <span class="keyword">in</span> <span class="variable">attr_map</span>) {
            <span class="variable">console</span>.<span class="variable">error</span>(<span class="string">'WARNING: Two or more schemas have the same attributes.'</span>);
        }
        <span class="variable">attr_map</span>[<span class="variable">key</span>] = <span class="variable">model</span>;
    }

    <span class="comment">//Work out which document schemas are embedded inside others</span>
    <span class="keyword">for</span> (<span class="variable">model</span> <span class="keyword">in</span> <span class="variable">mongoose</span>.<span class="variable">modelSchemas</span>) {
        <span class="variable">schema</span> = <span class="variable">mongoose</span>.<span class="variable">modelSchemas</span>[<span class="variable">model</span>];
        <span class="variable">child_map</span>[<span class="variable">model</span>] = [];
        <span class="keyword">for</span> (<span class="variable">attr</span> <span class="keyword">in</span> <span class="variable">schema</span>.<span class="variable">tree</span>) {
            (<span class="keyword">function</span> (<span class="variable">attr</span>) {
                <span class="keyword">if</span> (<span class="class">Array</span>.<span class="variable">isArray</span>(<span class="variable">schema</span>.<span class="variable">tree</span>[<span class="variable">attr</span>]) &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">schema</span>.<span class="variable">tree</span>[<span class="variable">attr</span>][<span class="number integer">0</span>].<span class="variable">path</span>) {
                    <span class="variable">key</span> = <span class="variable">attrKey</span>(<span class="variable">schema</span>.<span class="variable">tree</span>[<span class="variable">attr</span>][<span class="number integer">0</span>]);
                    <span class="variable">resource</span> = <span class="variable">attr_map</span>[<span class="variable">key</span>];
                    <span class="variable">child_map</span>[<span class="variable">model</span>].<span class="variable">push</span>({
                        <span class="variable">attribute</span> : <span class="variable">attr</span>
                      , <span class="variable">resource</span>  : <span class="variable">resource</span>
                      , <span class="variable">singular</span>  : <span class="variable">lingo</span>.<span class="variable">singularize</span>(<span class="variable">resource</span>)
                      , <span class="variable">plural</span>    : <span class="variable">lingo</span>.<span class="variable">pluralize</span>(<span class="variable">resource</span>)
                    });
                    <span class="variable">embedded</span>.<span class="variable">push</span>(<span class="variable">resource</span>);
                    <span class="keyword">if</span> (!(<span class="variable">resource</span> <span class="keyword">in</span> <span class="variable">parent_map</span>)) {
                        <span class="variable">parent_map</span>[<span class="variable">resource</span>] = [];
                    }
                    <span class="variable">parent_map</span>[<span class="variable">resource</span>].<span class="variable">push</span>({
                        <span class="variable">attribute</span> : <span class="variable">attr</span>
                      , <span class="variable">resource</span>  : <span class="variable">model</span>
                      , <span class="variable">singular</span>  : <span class="variable">lingo</span>.<span class="variable">singularize</span>(<span class="variable">model</span>)
                      , <span class="variable">plural</span>    : <span class="variable">lingo</span>.<span class="variable">pluralize</span>(<span class="variable">model</span>)
                    });
                }
            }(<span class="variable">attr</span>));
        }
    }

    <span class="comment">//Work out which resources are top level</span>
    <span class="class">Object</span>.<span class="variable">keys</span>(<span class="variable">mongoose</span>.<span class="variable">modelSchemas</span>).<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">resource</span>) {
        <span class="keyword">if</span> (!~<span class="variable">embedded</span>.<span class="variable">indexOf</span>(<span class="variable">resource</span>)) {
            <span class="variable">top_level</span>.<span class="variable">push</span>(<span class="variable">resource</span>);
        }
    });

}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Get top level resources.</p>

<h2></h2>

<ul><li><p><strong>return</strong>: <em>array</em>  resources</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">getTopLevel</span> = <span class="keyword">function</span> () {
    <span class="keyword">return</span> <span class="variable">top_level</span>;
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Get embedded resources.</p>

<h2></h2>

<ul><li><p><strong>return</strong>: <em>array</em>  resources</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">getEmbedded</span> = <span class="keyword">function</span> () {
    <span class="keyword">return</span> <span class="variable">embedded</span>;
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Get a map of parent =&gt; children resources.</p>

<h2></h2>

<ul><li><p><strong>return</strong>: <em>array</em>  map</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">getChildMap</span> = <span class="keyword">function</span> () {
    <span class="keyword">return</span> <span class="variable">child_map</span>;
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Get a map of child =&gt; parent resources.</p>

<h2></h2>

<ul><li><p><strong>return</strong>: <em>array</em>  map</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">getParentMap</span> = <span class="keyword">function</span> () {
    <span class="keyword">return</span> <span class="variable">parent_map</span>;
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Check whether a resource is top level.</p>

<h2></h2>

<ul><li><p><strong>return</strong>: <em>boolean</em>  is<em>top</em>level</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">isTopLevel</span> = <span class="keyword">function</span> (<span class="variable">resource</span>) {
    <span class="keyword">return</span> <span class="variable">exports</span>.<span class="variable">getTopLevel</span>().<span class="variable">indexOf</span>(<span class="variable">resource</span>) !== -<span class="number integer">1</span>;
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Check whether a resource is embedded in another.</p>

<h2></h2>

<ul><li><p><strong>return</strong>: <em>boolean</em>  is_embedded</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">isEmbedded</span> = <span class="keyword">function</span> (<span class="variable">resource</span>) {
    <span class="keyword">return</span> <span class="variable">exports</span>.<span class="variable">getEmbedded</span>().<span class="variable">indexOf</span>(<span class="variable">resource</span>) !== -<span class="number integer">1</span>;
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Get the children of the specified resource.</p>

<h2></h2>

<ul><li><p><strong>return</strong>: <em>array</em>  children</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">getChildren</span> = <span class="keyword">function</span> (<span class="variable">resource</span>) {
    <span class="keyword">return</span> <span class="variable">exports</span>.<span class="variable">getChildMap</span>()[<span class="variable">resource</span>] || [];
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Get the parents of the specified resource.</p>

<h2></h2>

<ul><li><p><strong>return</strong>: <em>array</em>  children</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">getParents</span> = <span class="keyword">function</span> (<span class="variable">resource</span>) {
    <span class="keyword">return</span> <span class="variable">exports</span>.<span class="variable">getParentMap</span>()[<span class="variable">resource</span>] || [];
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Check whether the resource has embedded resources.</p>

<h2></h2>

<ul><li><p><strong>return</strong>: <em>boolean</em>  has_children</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">hasChildren</span> = <span class="keyword">function</span> (<span class="variable">resource</span>) {
    <span class="keyword">return</span> <span class="variable">exports</span>.<span class="variable">getChildMap</span>()[<span class="variable">resource</span>] &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">exports</span>.<span class="variable">getChildMap</span>()[<span class="variable">resource</span>].<span class="variable">length</span>;
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Check whether the resource is embedded in others.</p>

<h2></h2>

<ul><li><p><strong>return</strong>: <em>boolean</em>  has_parents</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">hasParents</span> = <span class="keyword">function</span> (<span class="variable">resource</span>) {
    <span class="keyword">return</span> <span class="variable">exports</span>.<span class="variable">getParentMap</span>()[<span class="variable">resource</span>] &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">exports</span>.<span class="variable">getParentMap</span>()[<span class="variable">resource</span>].<span class="variable">length</span>;
}

</code></pre>
</td>
</tr><tr class="filename"><td><h2 id="lib/backbone.js"><a href="#">backbone</a></h2></td><td>lib/backbone.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies.
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">models</span> = <span class="variable">require</span>(<span class="string">'./models'</span>)
  , <span class="variable">fs</span> = <span class="variable">require</span>(<span class="string">'fs'</span>)
  , <span class="variable">lingo</span> = <span class="variable">require</span>(<span class="string">'lingo'</span>).<span class="variable">en</span>;</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Convert a lowercase, underscored string to a proper cased class name.
e.g. "my_table" =&gt; "MyTable"</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>string</em>  table</p></li><li><p><strong>return</strong>: <em>string</em>  class</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">classify</span> (<span class="variable">str</span>) {
    <span class="keyword">return</span> <span class="variable">str</span>.<span class="variable">replace</span>(<span class="string">'_'</span>, <span class="string">' '</span>).<span class="variable">replace</span>(<span class="regexp">/(^| )[a-z]/g</span>, <span class="keyword">function</span> (<span class="variable">str</span>) {
        <span class="keyword">return</span> <span class="variable">str</span>.<span class="variable">toUpperCase</span>();
    }).<span class="variable">replace</span>(<span class="string">' '</span>, <span class="string">''</span>);
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Recursively replace <code>_id</code> with <code>id</code> in an object.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>object</em>  instance</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">convertUnderscoreId</span> (<span class="variable">instance</span>) {
    <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">attr</span> <span class="keyword">in</span> <span class="variable">instance</span>) {
        <span class="keyword">if</span> (<span class="variable">attr</span> == <span class="string">'_id'</span>) {
            <span class="variable">instance</span>.<span class="variable">id</span> = <span class="variable">instance</span>[<span class="variable">attr</span>];
            <span class="keyword">delete</span> <span class="variable">instance</span>.<span class="variable">_id</span>;
        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="class">Array</span>.<span class="variable">isArray</span>(<span class="variable">instance</span>[<span class="variable">attr</span>])) {
            <span class="variable">instance</span>[<span class="variable">attr</span>].<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">child</span>) {
                <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable">child</span> === <span class="string">'object'</span>) {
                    <span class="variable">convertUnderscoreId</span>(<span class="variable">child</span>);
                }
            });
        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable">instance</span>[<span class="variable">attr</span>] === <span class="string">'object'</span>) {
            <span class="variable">convertUnderscoreId</span>(<span class="variable">instance</span>[<span class="variable">attr</span>]);
        }
    }
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Generate backbone models.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>string</em>  namespace (optional)</p></li><li><p><strong>return</strong>: <em>string</em>  backbone_javascript</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">generate</span> = <span class="keyword">function</span> (<span class="variable">app</span>, <span class="variable">namespace</span>) {
    <span class="variable">namespace</span> = <span class="variable">namespace</span> || <span class="string">''</span>;

    <span class="keyword">var</span> <span class="variable">backbone</span> = <span class="variable">backboneCommon</span>(<span class="variable">namespace</span>);

    <span class="variable">models</span>.<span class="variable">getEmbedded</span>().<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">resource</span>) {
        <span class="variable">backbone</span> += <span class="variable">backboneEmbeddedModel</span>(<span class="variable">namespace</span>, <span class="variable">resource</span>);
    });

    <span class="variable">models</span>.<span class="variable">getTopLevel</span>().<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">resource</span>) {
        <span class="variable">backbone</span> += <span class="variable">backboneTopLevelModel</span>(<span class="variable">namespace</span>,
                        <span class="variable">resource</span>, <span class="variable">models</span>.<span class="variable">getChildren</span>(<span class="variable">resource</span>));
    });

    <span class="keyword">return</span> <span class="variable">backbone</span>;
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Generate express view helpers for creating backbone models and collections.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>HTTPServer</em>  app</p></li><li><p><strong>param</strong>: <em>string</em>  namespace (optional)</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">helpers</span> = <span class="keyword">function</span> (<span class="variable">app</span>, <span class="variable">namespace</span>) {

    <span class="variable">namespace</span> = <span class="variable">namespace</span> || <span class="string">''</span>;

    <span class="variable">app</span>.<span class="variable">dynamicHelpers</span>({

        <span class="variable">backboneModel</span>: <span class="keyword">function</span> (<span class="variable">request</span>, <span class="variable">response</span>) {
            <span class="keyword">return</span> <span class="keyword">function</span> (<span class="variable">resource</span>, <span class="variable">var_name</span>) {
                <span class="keyword">var</span> <span class="variable">singular</span> = <span class="variable">resource</span>
                  , <span class="keyword">class</span> = <span class="variable">namespace</span> + <span class="variable">classify</span>(<span class="variable">resource</span>)
                  , <span class="variable">instance</span> = <span class="variable">request</span>.<span class="variable">resource</span>(<span class="variable">resource</span>);

                <span class="variable">var_name</span> = <span class="variable">var_name</span> || <span class="variable">resource</span>;

                <span class="keyword">if</span> (<span class="variable">instance</span>.<span class="variable">toJSONSafe</span>) {
                    <span class="variable">instance</span> = <span class="variable">instance</span>.<span class="variable">toJSONSafe</span>();
                } <span class="keyword">else</span> {
                    <span class="variable">instance</span> = <span class="variable">instance</span>.<span class="variable">toJSON</span>()
                }

                <span class="variable">convertUnderscoreId</span>(<span class="variable">instance</span>);

                <span class="keyword">var</span> <span class="variable">model</span> = <span class="string">'var '</span>+<span class="variable">var_name</span>+<span class="string">' = '</span>
                          + <span class="string">'new '</span>+<span class="keyword">class</span>+<span class="string">'('</span> + <span class="class">JSON</span>.<span class="variable">stringify</span>(<span class="variable">instance</span>) + <span class="string">');'</span>;

                <span class="keyword">return</span> <span class="variable">model</span>;
            }
        }

      , <span class="variable">backboneCollection</span>: <span class="keyword">function</span> (<span class="variable">request</span>, <span class="variable">response</span>) {
            <span class="keyword">return</span> <span class="keyword">function</span> (<span class="variable">resource</span>, <span class="variable">var_name</span>) {
                <span class="keyword">var</span> <span class="variable">singular</span> = <span class="variable">lingo</span>.<span class="variable">singularize</span>(<span class="variable">resource</span>)
                  , <span class="keyword">class</span> = <span class="variable">namespace</span> + <span class="variable">classify</span>(<span class="variable">singular</span>)
                  , <span class="variable">instances</span> = <span class="variable">request</span>.<span class="variable">resource</span>(<span class="variable">resource</span>);

                <span class="variable">var_name</span> = <span class="variable">var_name</span> || <span class="variable">resource</span>;

                <span class="keyword">for</span> (<span class="keyword">var</span> <span class="variable">i</span> = <span class="number integer">0</span>, <span class="variable">l</span> = <span class="variable">instances</span>.<span class="variable">length</span>; <span class="variable">i</span> &<span class="variable">lt</span>; <span class="variable">l</span>; <span class="variable">i</span>++) {
                    <span class="keyword">if</span> (<span class="variable">instances</span>[<span class="variable">i</span>].<span class="variable">toJSONSafe</span>) {
                        <span class="variable">instances</span>[<span class="variable">i</span>] = <span class="variable">instances</span>[<span class="variable">i</span>].<span class="variable">toJSONSafe</span>();
                    } <span class="keyword">else</span> {
                        <span class="variable">instances</span>[<span class="variable">i</span>] = <span class="variable">instances</span>[<span class="variable">i</span>].<span class="variable">toJSON</span>()
                    }

                    <span class="variable">convertUnderscoreId</span>(<span class="variable">instances</span>[<span class="variable">i</span>]);
                }

                <span class="keyword">var</span> <span class="variable">collection</span> = <span class="string">'var '</span>+<span class="variable">var_name</span>+<span class="string">' = '</span>
                               + <span class="string">'new '</span>+<span class="keyword">class</span>+<span class="string">'Collection('</span> + <span class="class">JSON</span>.<span class="variable">stringify</span>(<span class="variable">instances</span>) + <span class="string">');'</span>;

                <span class="keyword">return</span> <span class="variable">collection</span>;
            }
        }

    });
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Generate backbone models and write to a file.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>string</em>  file</p></li><li><p><strong>param</strong>: <em>string</em>  namespace (optional)</p></li><li><p><strong>api</strong>: <em>public</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">exports</span>.<span class="variable">generateFile</span> = <span class="keyword">function</span> (<span class="variable">app</span>, <span class="variable">file</span>, <span class="variable">namespace</span>) {
    <span class="variable">fs</span>.<span class="variable">writeFileSync</span>(<span class="variable">file</span>, <span class="variable">exports</span>.<span class="variable">generate</span>(<span class="variable">app</span>, <span class="variable">namespace</span>));
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Generate common backbone code.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>string</em>  namespace (optional)</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">backboneCommon</span> (<span class="variable">namespace</span>) {
    <span class="keyword">return</span> <span class="string">'var '</span>+<span class="variable">namespace</span>+<span class="string">'Model = Backbone.Model.extend({\n'</span>
         + <span class="string">'    set: function (attributes, options) {\n'</span>
         + <span class="string">'        Backbone.Model.prototype.set.call(this, '</span>
         +              <span class="string">'attributes, options);\n'</span>
         + <span class="string">'        this.pullEmbedded();\n'</span>
         + <span class="string">'    }\n'</span>
         + <span class="string">'  , pullEmbedded: function () {\n'</span>
         + <span class="string">'        for (var attr in this.attributes) {\n'</span>
         + <span class="string">'            if (this[attr] &amp;&amp; this[attr] instanceof Backbone.Collection) {\n'</span>
         + <span class="string">'                for (var i = 0, models = [], model = this[attr].model, '</span>
         +                          <span class="string">'l = this.attributes[attr].length; i &lt; l; i++) {\n'</span>
         + <span class="string">'                    models.push(new model(this.attributes[attr][i]));\n'</span>
         + <span class="string">'                }\n'</span>
         + <span class="string">'                this[attr].reset(models);\n'</span>
         + <span class="string">'                delete this.attributes[attr];\n'</span>
         + <span class="string">'            }\n'</span>
         + <span class="string">'        }\n'</span>
         + <span class="string">'    }\n'</span>
         + <span class="string">'});\n'</span>
         + <span class="string">'\n\n'</span>
         + <span class="string">'var '</span>+<span class="variable">namespace</span>+<span class="string">'Collection = Backbone.Collection.extend({});\n\n'</span>;
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Generate backbone code for embedded models.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>string</em>  namespace (optional)</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">backboneEmbeddedModel</span> (<span class="variable">namespace</span>, <span class="variable">resource</span>) {
    <span class="keyword">var</span> <span class="variable">singular</span> = <span class="variable">namespace</span> + <span class="variable">classify</span>(<span class="variable">lingo</span>.<span class="variable">singularize</span>(<span class="variable">resource</span>));

    <span class="keyword">return</span> <span class="string">'var '</span>+<span class="variable">singular</span>+<span class="string">' = '</span>+<span class="variable">namespace</span>+<span class="string">'Model.extend({})\n'</span>
         + <span class="string">'  , '</span>+<span class="variable">singular</span>+<span class="string">'Collection = '</span>
         + <span class="variable">namespace</span>+<span class="string">'Collection.extend({ model: '</span>+<span class="variable">singular</span>+<span class="string">' });\n\n'</span>;
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Generate backbone code for top level models.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>string</em>  namespace (optional)</p></li><li><p><strong>api</strong>: <em>private</em></p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">backboneTopLevelModel</span> (<span class="variable">namespace</span>, <span class="variable">resource</span>, <span class="variable">children</span>) {
    <span class="keyword">var</span> <span class="variable">singular</span> = <span class="variable">namespace</span> + <span class="variable">classify</span>(<span class="variable">lingo</span>.<span class="variable">singularize</span>(<span class="variable">resource</span>))
      , <span class="variable">plural</span> = <span class="variable">lingo</span>.<span class="variable">pluralize</span>(<span class="variable">resource</span>)
      , <span class="variable">backbone</span> = <span class="string">''</span>;

    <span class="variable">backbone</span> += <span class="string">'var '</span>+<span class="variable">singular</span>+<span class="string">' = Model.extend({\n'</span>
              + <span class="string">'    urlRoot: \'</span>/<span class="string">'+plural+'</span>\<span class="string">'\n'</span>;

    <span class="keyword">if</span> (<span class="variable">models</span>.<span class="variable">hasChildren</span>(<span class="variable">resource</span>)) {
        <span class="variable">backbone</span> += <span class="string">'  , initialize: function () {\n'</span>;
        <span class="variable">models</span>.<span class="variable">getChildren</span>(<span class="variable">resource</span>).<span class="variable">forEach</span>(<span class="keyword">function</span> (<span class="variable">em</span>) {
            <span class="variable">backbone</span> += <span class="string">'        this.'</span>+<span class="variable">em</span>.<span class="variable">attribute</span>+<span class="string">' = new '</span>
                      + <span class="variable">namespace</span> + <span class="variable">classify</span>(<span class="variable">em</span>.<span class="variable">singular</span>) + <span class="string">'Collection;\n'</span>
                      + <span class="string">'        this.'</span>+<span class="variable">em</span>.<span class="variable">attribute</span>+<span class="string">'.url = \'</span>/'+<span class="variable">plural</span>
                      + <span class="string">'/\'</span> + <span class="this">this</span>.<span class="variable">id</span> + \<span class="string">'/'</span>+<span class="variable">em</span>.<span class="variable">plural</span>+<span class="string">'\'</span>\<span class="variable">n</span>';
        });
        <span class="variable">backbone</span> += <span class="string">'        this.pullEmbedded();\n'</span>
                  + <span class="string">'    }\n'</span>;
    }

    <span class="variable">backbone</span> += <span class="string">'});\n\n'</span>;

    <span class="variable">backbone</span> += <span class="string">'var '</span> + <span class="variable">singular</span> + <span class="string">'Collection = Collection.extend({\n'</span>
              + <span class="string">'    model: '</span> + <span class="variable">singular</span> + <span class="string">'\n'</span>
              + <span class="string">'  , url: \'</span>/<span class="string">' + plural + '</span>\<span class="string">'\n'</span>
              + <span class="string">'});\n\n'</span>;

    <span class="keyword">return</span> <span class="variable">backbone</span>;
}

</code></pre>
</td>
</tr>	</body>
</html></tbody></table>